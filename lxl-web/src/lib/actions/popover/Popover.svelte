<script lang="ts">
	import { onMount } from 'svelte';
	import { computePosition, offset, shift, inline, flip, arrow } from '@floating-ui/dom';
	import DecoratedData from '$lib/components/DecoratedData.svelte';
	import type { ResourceData } from '$lib/types/resourceData';

	interface Props {
		title?: string | undefined;
		resourceData?: ResourceData | undefined;
		referenceElement: HTMLElement;
		onMouseOver: (event: MouseEvent) => void;
		onMouseLeave: (event: MouseEvent) => void;
		onFocus: (event: FocusEvent) => void;
		onBlur: (event: FocusEvent) => void;
	}

	let {
		title = undefined,
		resourceData = undefined,
		referenceElement,
		onMouseOver,
		onMouseLeave,
		onFocus,
		onBlur
	}: Props = $props();

	let popoverElement: HTMLElement | undefined = $state();
	let arrowElement: HTMLDivElement | undefined = $state();

	const arrowWidth = 14;
	const arrowHeight = 8;

	function updatePosition() {
		if (popoverElement && arrowElement) {
			computePosition(referenceElement, popoverElement, {
				middleware: [
					offset(8),
					shift({ padding: 24 }),
					arrow({ element: arrowElement, padding: 8 }),
					inline(),
					flip()
				]
			}).then(({ strategy, x, y, middlewareData, placement }) => {
				if (popoverElement) {
					Object.assign(popoverElement.style, {
						position: strategy,
						left: `${x}px`,
						top: `${y}px`
					});
				}

				if (middlewareData.arrow) {
					const { x: arrowX, y: arrowY } = middlewareData.arrow;
					if (arrowElement) {
						Object.assign(arrowElement.style, {
							top:
								(arrowY != null && `${arrowY}px`) ||
								(placement === 'bottom' && `-${arrowWidth}px`) ||
								'',
							left:
								(arrowX != null && `${arrowX}px`) ||
								(placement === 'right' && `-${arrowWidth}px`) ||
								'',
							right: (arrowX == null && placement === 'left' && `-${arrowWidth}px`) || '',
							transform:
								(placement === 'right' && 'rotate(90deg)') ||
								(placement === 'bottom' && 'rotate(180deg)') ||
								(placement === 'left' && 'rotate(270deg)') ||
								''
						});
					}
				}
			});
		}
	}

	onMount(() => {
		updatePosition();
	});
</script>

<!-- 
  @component
	Renders a popover.
	Note that `Popover.svelte` isn't intended to be used directly in page templates â€“ use the `use:popover` instead (see `$lib/actions/popover`).
-->
<div
	class="absolute left-0 top-0 z-50 w-max max-w-sm rounded-md border border-primary/16 bg-cards text-sm shadow-xl"
	role="complementary"
	bind:this={popoverElement}
	onmouseover={onMouseOver}
	onmouseleave={onMouseLeave}
	onfocus={onFocus}
	onblur={onBlur}
>
	<div class="p-2">
		{#if resourceData}
			<DecoratedData data={resourceData} block allowPopovers={false} />
		{:else if title}
			{title}
		{/if}
	</div>
	<div class="absolute" bind:this={arrowElement}>
		<svg
			aria-hidden="true"
			width={arrowWidth}
			height={arrowWidth}
			viewBox="0 0 {arrowWidth} {arrowWidth}"
		>
			<path d="M0 0L{arrowWidth / 2} {arrowHeight}L{arrowWidth} 0" fill="#fff" stroke="#c3c3c3" />
		</svg>
	</div>
</div>
